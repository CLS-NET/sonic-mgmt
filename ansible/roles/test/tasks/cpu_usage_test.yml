######################################################
# Run BGP session flapping and monitor the DUT cpu 
# usage infor.
######################################################
- debug: msg="cpu monitor pre checks."

- fail: msg="testbed_type is not defined."
  when: testbed_type is not defined

- fail: msg="testbed_type {{testbed_type}} is invalid."
  when: testbed_type not in testcases['cpu_usage']['topologies']

- name: Copy bgp_intf_flap.sh to the Dut.
  become: true
  copy:
    src: roles/test/files/helpers/bgp_intf_flap.sh
    dest: /tmp/bgp_intf_flap.sh
    mode: 0777

- name: Copy cal_cpu_us.py to the Dut.
  become: true
  copy:
    src: roles/test/files/helpers/cal_cpu_us.py
    dest: /tmp/cal_cpu_us.py
    mode: 0777

- name: Run bgp_intf_flap.sh on Dut.
  become: true
  shell: "nohup /tmp/bgp_intf_flap.sh 22 5 0 15 &"

- name: wait 10 seconds.
  pause: seconds=10

- name: Run cal_cpu_us.py on Dut.
  become: true
  shell: "nohup python /tmp/cal_cpu_us.py -t 90 &"

- name: wait 150 seconds.
  pause: seconds=150

- name: Copy the CPU usage infor to local.
  fetch:
    src: '/tmp/cpu_usage.txt'
    dest: '/tmp/'
    flat: yes
- name: Remove cal_cpu_us.py file
  become: true
  file: path="/tmp/cal_cpu_us.py" state=absent

- name: Remove bgp_intf_flap.sh file
  become: true
  file: path="/tmp/bgp_intf_flap.sh" state=absent
