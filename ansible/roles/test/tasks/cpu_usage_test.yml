######################################################
# Run BGP session flapping and monitor the DUT cpu 
# usage infor.
######################################################
- debug: msg="cpu monitor pre checks."

- fail: msg="testbed_type is not defined."
  when: testbed_type is not defined

- fail: msg="testbed_type {{testbed_type}} is invalid."
  when: testbed_type not in testcases['cpu_usage']['topologies']

- name: Gather minigraph facts about the device
  minigraph_facts: host={{inventory_hostname}}

- name: Get interface facts
  interface_facts: up_ports={{minigraph_ports}}

- name: Generate BGP interfaces flap shell file
  become: true
  template: src=roles/test/templates/bgp_intf_flap.j2 dest=/tmp/bgp_intf_flap.sh mode=0777
  with_items:
    - {flap_t: 22,
       intval: 5,
       bgp_nb: "{{ minigraph_bgp }}",
       intf_ips: "{{ ansible_interface_ips['all_ipv4_addresses'] }}",
       intf_ls: "{{ ansible_interface_facts }}"}

- name: Copy cal_cpu_us.py to the Dut.
  become: true
  copy:
    src: roles/test/files/helpers/cal_cpu_us.py
    dest: /tmp/cal_cpu_us.py
    mode: 0777

- name: Run bgp_intf_flap.sh on Dut.
  become: true
  shell: "nohup /tmp/bgp_intf_flap.sh &"

- name: wait 10 seconds.
  pause: seconds=10

- name: Run cal_cpu_us.py on Dut.
  become: true
  shell: "nohup python /tmp/cal_cpu_us.py -t 90 &"

- name: wait 240 seconds.
  pause: seconds=240

- name: Copy the CPU usage infor to local.
  fetch:
    src: '/tmp/cpu_usage.txt'
    dest: '/tmp/'
    flat: yes
- name: Remove cal_cpu_us.py file
  become: true
  file: path="/tmp/cal_cpu_us.py" state=absent

- name: Remove bgp_intf_flap.sh file
  become: true
  file: path="/tmp/bgp_intf_flap.sh" state=absent
